'use strict'
const AdmZip = require('adm-zip')
const { move } = require('piscina')

module.exports = ({ files, filesToUpload, filesToDelete, map }) => {
  const archive = new AdmZip()

  if (filesToDelete.length !== 0) {
    const filesToDeleteContent = JSON.stringify(filesToDelete)
    archive.addFile('deleted.files', Buffer.alloc(filesToDeleteContent.length, filesToDeleteContent))
  }

  const mapContent = JSON.stringify(map)
  archive.addFile('source.map', Buffer.alloc(mapContent.length, mapContent))

  const previousMap = JSON.parse(mapContent)

  for (const filePath of filesToUpload) {
    const mode = files[filePath].mode & 0o100 ? 0o755 : 0o644
    archive.addFile(filePath, files[filePath].file, null, mode)
  }

  const zipBuffer = archive.toBuffer()

  return move({ zipBuffer, previousMap })
}
