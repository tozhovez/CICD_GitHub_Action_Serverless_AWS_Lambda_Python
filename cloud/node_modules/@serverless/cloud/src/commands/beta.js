'use strict'

const User = require('../models/User')
const Org = require('../models/Org')
const BetaCode = require('../models/BetaCode')

const login = require('./login')

async function generateCode(betaCode, cli) {
  const item = await betaCode.create(cli.options)
  cli.log(`Generated new beta code: ${item.code}`)
}

async function listCodes(betaCode, cli) {
  const items = await betaCode.query(cli.options)
  for (const item of items) {
    cli.log(
      `${item.code} ${item.email} ${cli.styles.dim(
        item.activatedAt
          ? `activated ${new Date(item.activatedAt).toLocaleString()} for org "${item.orgName}"`
          : `created ${new Date(item.createdAt).toLocaleString()}`
      )}`
    )
  }
}

const commands = {
  'generate-code': generateCode,
  'list-codes': listCodes
}

module.exports = async (cli) => {
  const user = new User()

  if (!user.isLoggedIn()) {
    cli.logInfo('Please login to proceed.')
    await login(cli)
    user.load()
  }

  const org = new Org({ user })
  await org.authorize()

  const commandName = cli.args[0]

  const commandFunction = commands[commandName]

  if (!commandFunction) {
    throw new Error('Unknown command')
  }

  const betaCode = new BetaCode({ org })

  await commandFunction(betaCode, cli)
}
