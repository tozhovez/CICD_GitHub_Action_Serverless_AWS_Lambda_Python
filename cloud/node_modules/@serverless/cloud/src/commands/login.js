'use strict'

const open = require('open')
const User = require('../models/User')
const Org = require('../models/Org')
const Analytics = require('../models/Analytics')

const trySendAnalytics = async () => {
  try {
    const user = new User()
    const org = new Org({ user })
    await org.authorize()

    if (org.accessKey && org.orgName) {
      const analytics = new Analytics({ org })
      await analytics.publish('cloud.cli.login', {})
    }
  } catch (e) {
    if (process.env.SLS_DEBUG) {
      console.error(e)
    }
  }
}

module.exports = async (cli) => {
  cli.viewSpinner('Awaiting login')

  const user = new User()

  cli.logInfo('Your browser should open automatically.')

  const loginUrl = await user.startLogin()

  cli.logInfo('If not, open the following login url:')
  cli.logUrl(loginUrl)

  open(loginUrl)

  await user.endLogin()

  await trySendAnalytics()

  cli.logSuccess('Successfully logged into Serverless Cloud.')
}
