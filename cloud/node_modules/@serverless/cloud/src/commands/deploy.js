'use strict'

const isCI = require('../utils/isCI')
const stringifyTimer = require('../utils/stringifyTimer')
const FS = require('../models/FS')
const Code = require('../models/Code')
const User = require('../models/User')
const Org = require('../models/Org')
const Service = require('../models/Service')
const Instance = require('../models/Instance')
const Analytics = require('../models/Analytics')

const login = require('./login')
const activate = require('./activate')

module.exports = async (cli) => {
  cli.viewSpinner('Loading')
  const user = new User()

  if (!user.isLoggedIn() && !isCI) {
    cli.logInfo('Please login to proceed.')
    await login(cli)
    user.load()
  }

  const fs = new FS({ user })
  await fs.read()

  if (!fs.serviceFile) {
    throw new Error(`You must be inside a Serverless Cloud app directory to run this command.`)
  }

  let instanceName = cli.args[0]

  const serviceName = cli.options.app || fs.serviceFile.serverless.app
  const orgName = cli.options.org || fs.serviceFile.serverless.org
  const instanceType = cli.options.type || 'stage'

  if (!orgName) {
    throw new Error(`Please specify a serverless org name in package.json or with the --org CLI param.`)
  }

  const org = new Org({ user, orgName })
  await org.authorize()

  if (!(await org.isActivated())) {
    if (isCI) {
      throw new Error(`Your org "${orgName}" is not activated for Serverless Cloud.`)
    }

    cli.logActivation(orgName)
    await activate(cli)
  }

  const analytics = new Analytics({ org })

  if (!instanceName) {
    if (isCI) {
      throw new Error(`Please specify a stage name: "cloud deploy dev"`)
    }

    cli.logInfo(`Please enter the name of the stage you want to deploy to.`)
    instanceName = await cli.prompt(`type a stage name`)
  }

  cli.viewSpinner(`Validating`)

  const service = new Service({ org, serviceName })

  cli.viewSpinner(`Deploying to ${instanceName} (${instanceType})`, { timer: true })

  const instance = new Instance({
    org,
    service,
    instanceName,
    instanceType
  })

  const code = new Code({
    fs,
    org,
    service,
    instance,
    analytics
  })

  await code.init()
  await code.deploy()

  await instance.get()

  cli.logSuccess(`Successfully deployed to the "${instanceName}" stage in ${stringifyTimer(cli.timer)}.`)

  cli.logUrl(instance.url)
}
